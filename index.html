<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Genba Painting</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-section { display: none !important; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        .status-card { transition: transform 0.2s; }
        .status-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside id="sidebar-panel" class="w-64 bg-slate-900 text-white flex-col hidden md:hidden">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <i class="fa-solid fa-paint-roller text-blue-400 text-2xl"></i>
            <div>
                <h1 class="font-bold text-lg">GENBA SYSTEM</h1>
                <p class="text-xs text-slate-400">Painting Dept.</p>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <div id="menu-admin" class="hidden-section">
                <p class="text-xs font-bold text-slate-500 uppercase mb-2 px-2">Menu Admin</p>
                <button onclick="showSection('page-admin')" class="w-full text-left px-4 py-3 rounded hover:bg-slate-800 text-slate-300 hover:text-white transition">
                    <i class="fa-solid fa-qrcode w-6"></i> Manajemen QR
                </button>
            </div>

            <div id="menu-chief" class="hidden-section">
                <p class="text-xs font-bold text-slate-500 uppercase mb-2 px-2">Menu Chief</p>
                <button onclick="showSection('page-chief')" class="w-full text-left px-4 py-3 rounded hover:bg-slate-800 text-slate-300 hover:text-white transition">
                    <i class="fa-solid fa-camera w-6"></i> Scan Barcode
                </button>
            </div>

            <div id="menu-depthead" class="hidden-section">
                <p class="text-xs font-bold text-slate-500 uppercase mb-2 px-2">Menu Dept Head</p>
                <button onclick="showSection('page-depthead')" class="w-full text-left px-4 py-3 rounded hover:bg-slate-800 text-slate-300 hover:text-white transition">
                    <i class="fa-solid fa-chart-line w-6"></i> Dashboard
                </button>
            </div>

            <div class="mt-4 border-t border-slate-700 pt-4">
                <button onclick="logout()" class="w-full text-left px-4 py-3 rounded hover:bg-slate-800 text-red-400 font-semibold transition">
                    <i class="fa-solid fa-power-off w-6"></i> Logout
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-950">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold" id="user-initial">U</div>
                <div>
                    <p class="text-sm font-semibold truncate w-32" id="sidebar-username">User</p>
                    <p class="text-xs text-green-400 uppercase tracking-wider" id="sidebar-role">Role</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-y-auto bg-slate-50 relative">
        
        <header id="mobile-header" class="bg-white shadow-sm p-4 md:hidden flex justify-between items-center hidden-section sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-paint-roller text-blue-600"></i>
                <h1 class="font-bold text-slate-800">GENBA PAINTING</h1>
            </div>
            <button onclick="logout()" class="text-red-500 bg-red-50 p-2 rounded-lg"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <div class="p-4 md:p-8 max-w-7xl mx-auto w-full">
            
            <section id="page-login" class="min-h-[80vh] flex items-center justify-center">
                <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800">Login Genba</h2>
                        <p class="text-slate-500 text-sm mt-1">Sistem Kontrol Line Painting</p>
                    </div>
                    
                    <form onsubmit="handleLogin(event)" class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Username</label>
                            <input type="text" id="username-input" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ketik: yanto / singgih" required autocomplete="off">
                        </div>
                        <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white py-3.5 rounded-lg font-bold hover:bg-blue-700 transition">MASUK SISTEM</button>
                    </form>
                </div>
            </section>

            <section id="page-chief" class="hidden-section max-w-lg mx-auto">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-slate-200">
                    <h2 class="text-xl font-bold text-slate-800">ðŸ‘‹ Halo, Chief!</h2>
                    <p class="text-slate-500 text-sm mb-2">Scan QR Code di area Line.</p>
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded" id="chief-shift-badge">Loading Shift...</span>
                </div>

                <div class="bg-slate-900 p-4 rounded-3xl shadow-lg border-4 border-slate-800 overflow-hidden relative">
                    <div id="reader"></div>
                    <p class="text-center text-slate-400 text-xs mt-2">Kamera Aktif</p>
                </div>

                <div class="mt-8">
                    <h3 class="font-bold text-slate-700 mb-3">Riwayat Scan Hari Ini</h3>
                    <ul id="chief-logs" class="space-y-3"></ul>
                </div>
            </section>

            <section id="page-depthead" class="hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Dashboard Monitoring</h2>
                        <p class="text-slate-500">Real-time status</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-slate-800 font-mono" id="clock">00:00</div>
                        <div class="text-xs font-bold text-blue-600 uppercase" id="monitor-shift">SHIFT -</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5" id="line-status-container"></div>
                
                <div class="mt-10 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-lg mb-4">Log Aktivitas Terbaru</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <tbody id="all-logs-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="page-admin" class="hidden-section">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-8">
                    <h2 class="text-xl font-bold mb-4">Manajemen QR Code</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6" id="admin-qr-container"></div>
                </div>
            </section>

        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ==========================================
        // KONFIGURASI SUPABASE (GANTI INI!)
        // ==========================================
        const SUPABASE_URL = 'https://fbfvhcwisvlyodwvmpqg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiZnZoY3dpc3ZseW9kd3ZtcHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTQ2MzQsImV4cCI6MjA3MjM5MDYzNH0.mbn9B1xEr_8kmC2LOP5Jv5O7AEIK7Fa1gxrqJ91WNx4';
        
        // Inisialisasi Client Supabase (HANYA SEKALI DISINI)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let locations = [];
        let html5QrcodeScanner = null;
        let dashboardInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateClock, 1000);
            updateClock();
        });

        // --- NAVIGATION ---
        function showSection(sectionId) {
            document.querySelectorAll('main section').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(sectionId).classList.remove('hidden-section');
        }

        // --- LOGIN LOGIC ---
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const input = document.getElementById('username-input');
            const username = input.value.trim().toLowerCase();

            if (!username) return;

            btn.innerText = 'Checking...';
            btn.disabled = true;

            try {
                const { data, error } = await supabase.from('users').select('*').eq('username', username).single();

                if (error || !data) throw new Error('User not found');

                currentUser = data;
                setupUIForUser(currentUser);
                Swal.fire({ icon: 'success', title: `Halo, ${currentUser.full_name}`, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });

            } catch (err) {
                Swal.fire('Gagal', 'Username tidak ditemukan. Coba: yanto / singgih / admin', 'error');
            } finally {
                btn.innerText = 'MASUK SISTEM';
                btn.disabled = false;
            }
        }

        function setupUIForUser(user) {
            document.getElementById('page-login').classList.add('hidden-section');
            document.getElementById('sidebar-panel').classList.remove('md:hidden');
            document.getElementById('sidebar-panel').classList.add('md:flex');
            document.getElementById('mobile-header').classList.remove('hidden-section');
            
            document.getElementById('sidebar-username').innerText = user.full_name;
            document.getElementById('sidebar-role').innerText = user.role.toUpperCase();
            document.getElementById('user-initial').innerText = user.full_name.charAt(0);

            if (user.role === 'chief') {
                document.getElementById('menu-chief').classList.remove('hidden-section');
                showSection('page-chief');
                initChiefMode();
            } else if (user.role === 'dept_head') {
                document.getElementById('menu-depthead').classList.remove('hidden-section');
                showSection('page-depthead');
                initDeptHeadMode();
            } else if (user.role === 'admin') {
                document.getElementById('menu-admin').classList.remove('hidden-section');
                showSection('page-admin');
                initAdminMode();
            }
        }

        function logout() {
            if (html5QrcodeScanner) html5QrcodeScanner.clear();
            if (dashboardInterval) clearInterval(dashboardInterval);
            location.reload();
        }

        // --- TIME & SHIFT ---
        function getShift() {
            const h = new Date().getHours();
            if (h >= 7 && h < 15) return 'SHIFT 1';
            if (h >= 15 && h < 23) return 'SHIFT 2';
            return 'SHIFT 3';
        }

        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
            if(document.getElementById('clock')) document.getElementById('clock').innerText = time;
            if(document.getElementById('monitor-shift')) document.getElementById('monitor-shift').innerText = getShift();
            if(document.getElementById('chief-shift-badge')) document.getElementById('chief-shift-badge').innerText = getShift();
        }

        // --- CHIEF MODE ---
        async function initChiefMode() {
            const { data } = await supabase.from('locations').select('*');
            if(data) locations = data;
            loadChiefLogs();
            startScanner();
        }

        function startScanner() {
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess)
            .catch(err => Swal.fire("Camera Error", "Izin kamera diperlukan.", "error"));
        }

        async function onScanSuccess(decodedText) {
            html5QrcodeScanner.pause();
            const loc = locations.find(l => l.code === decodedText);

            if (loc) {
                Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
                const { error } = await supabase.from('genba_logs').insert([{
                    user_name: currentUser.full_name,
                    location_id: loc.id,
                    shift: getShift()
                }]);

                if (!error) {
                    await Swal.fire({ icon: 'success', title: 'OK!', text: `${loc.name} terscan.`, timer: 1500, showConfirmButton: false });
                    loadChiefLogs();
                } else {
                    Swal.fire('Gagal', 'Koneksi error.', 'error');
                }
            } else {
                await Swal.fire('Salah QR', 'Bukan QR Line Painting.', 'warning');
            }
            setTimeout(() => html5QrcodeScanner.resume(), 1000);
        }

        async function loadChiefLogs() {
            const today = new Date().toISOString().split('T')[0];
            const { data } = await supabase.from('genba_logs').select('*, locations(name)').gte('scan_time', today).eq('user_name', currentUser.full_name).order('scan_time', { ascending: false }).limit(5);
            
            const ul = document.getElementById('chief-logs');
            ul.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(log => {
                    ul.innerHTML += `<li class="bg-white p-3 rounded border border-slate-200 flex justify-between"><span class="font-bold text-sm">${log.locations.name}</span><span class="text-xs text-slate-400">${new Date(log.scan_time).toLocaleTimeString()}</span></li>`;
                });
            } else {
                ul.innerHTML = '<li class="text-center text-sm text-slate-400">Belum ada scan.</li>';
            }
        }

        // --- DEPT HEAD MODE ---
        async function initDeptHeadMode() {
            renderDashboard();
            dashboardInterval = setInterval(renderDashboard, 10000);
        }

        async function renderDashboard() {
            const { data: locs } = await supabase.from('locations').select('*').order('id');
            const { data: logs } = await supabase.from('genba_logs').select('*').eq('shift', getShift()).gte('scan_time', new Date().toISOString().split('T')[0]);
            
            const container = document.getElementById('line-status-container');
            container.innerHTML = '';

            locs.forEach(loc => {
                const log = logs.find(l => l.location_id === loc.id);
                const isDone = !!log;
                const statusHtml = isDone 
                    ? `<div class="bg-green-50 border border-green-200 p-4 rounded-xl"><div class="flex justify-between mb-2"><h4 class="font-bold text-sm">${loc.name}</h4><i class="fa-solid fa-check-circle text-green-500 text-xl"></i></div><p class="text-xs text-green-700 font-bold bg-green-200 inline-block px-2 rounded">SUDAH</p><p class="text-xs text-slate-500 mt-2">Oleh: ${log.user_name}<br>Jam: ${new Date(log.scan_time).toLocaleTimeString()}</p></div>`
                    : `<div class="bg-white border border-slate-200 border-l-4 border-l-red-500 p-4 rounded-xl"><div class="flex justify-between mb-2"><h4 class="font-bold text-sm">${loc.name}</h4><i class="fa-solid fa-xmark text-slate-300 text-xl"></i></div><p class="text-xs text-red-600 font-bold bg-red-100 inline-block px-2 rounded">BELUM</p><p class="text-xs text-slate-400 mt-2">Menunggu scan...</p></div>`;
                container.innerHTML += statusHtml;
            });

            // Table logs
            const { data: recent } = await supabase.from('genba_logs').select('*, locations(name)').order('scan_time', { ascending: false }).limit(10);
            const tbody = document.getElementById('all-logs-table');
            tbody.innerHTML = '';
            recent.forEach(r => {
                tbody.innerHTML += `<tr class="border-b"><td class="p-3 text-slate-500 text-xs">${new Date(r.scan_time).toLocaleString()}</td><td class="p-3 font-bold">${r.user_name}</td><td class="p-3">${r.locations.name}</td></tr>`;
            });
        }

        // --- ADMIN MODE ---
        async function initAdminMode() {
            const { data: locs } = await supabase.from('locations').select('*').order('id');
            const container = document.getElementById('admin-qr-container');
            container.innerHTML = '';
            locs.forEach(loc => {
                const div = document.createElement('div');
                div.className = "bg-white border border-slate-200 p-4 rounded-lg flex flex-col items-center text-center";
                div.innerHTML = `<h4 class="font-bold text-sm mb-2">${loc.name}</h4><div id="qr-${loc.id}" class="mb-2"></div><button onclick="printQR('qr-${loc.id}', '${loc.name}')" class="bg-slate-800 text-white text-xs px-3 py-2 rounded hover:bg-black">Print QR</button>`;
                container.appendChild(div);
                new QRCode(div.querySelector(`#qr-${loc.id}`), { text: loc.code, width: 100, height: 100 });
            });
        }

        function printQR(id, title) {
            const html = document.getElementById(id).innerHTML;
            const win = window.open('', '', 'width=400,height=400');
            win.document.write(`<html><body style="text-align:center;font-family:sans-serif;"><h2>${title}</h2>${html}<p>SCAN DISINI</p></body></html>`);
            win.document.close();
            win.print();
        }
    </script>
</body>
</html>